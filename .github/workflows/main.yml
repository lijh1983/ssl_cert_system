name: Build Docker Base Image

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'é•œåƒç‰ˆæœ¬æ ‡ç­¾'
        required: true
        default: 'latest'
        type: string
      push_to_registry:
        description: 'æ˜¯å¦æ¨é€åˆ°å®¹å™¨æ³¨å†Œè¡¨'
        required: true
        default: true
        type: boolean
  
  # æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ main ]
    paths:
      - 'Dockerfile.base'
      - 'go.mod'
      - 'go.sum'
      - 'frontend/package.json'
      - '.github/workflows/main.yml'
  
  # PRåˆ°mainåˆ†æ”¯æ—¶è§¦å‘ï¼ˆä»…æ„å»ºï¼Œä¸æ¨é€ï¼‰
  pull_request:
    branches: [ main ]
    paths:
      - 'Dockerfile.base'
      - 'go.mod'
      - 'go.sum'
      - 'frontend/package.json'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}-base

jobs:
  build-base-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ç™»å½•åˆ°Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: æå–å…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=raw,value=latest,enable={{is_default_branch}}
          type=raw,value=${{ inputs.version }},enable=${{ github.event_name == 'workflow_dispatch' }}
          type=sha,prefix={{branch}}-
        labels: |
          org.opencontainers.image.title=SSL Certificate Management System Base Image
          org.opencontainers.image.description=Base Docker image for SSL Certificate Management System
          org.opencontainers.image.vendor=lijh1983

    - name: æ„å»ºå¹¶æ¨é€Dockeré•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.base
        platforms: linux/amd64,linux/arm64
        push: ${{ github.event_name != 'pull_request' && (github.event_name != 'workflow_dispatch' || inputs.push_to_registry) }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        build-args: |
          VERSION=1.0.2
          BUILD_TIME=${{ github.event.head_commit.timestamp }}
          GIT_COMMIT=${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: è¾“å‡ºé•œåƒä¿¡æ¯
      run: |
        echo "ğŸ³ Dockeré•œåƒæ„å»ºå®Œæˆï¼"
        echo "ğŸ“‹ é•œåƒä¿¡æ¯:"
        echo "  - æ³¨å†Œè¡¨: ${{ env.REGISTRY }}"
        echo "  - é•œåƒå: ${{ env.IMAGE_NAME }}"
        echo "  - æ ‡ç­¾: ${{ steps.meta.outputs.tags }}"
        echo "  - å¹³å°: linux/amd64, linux/arm64"
        echo ""
        if [[ "${{ github.event_name }}" != "pull_request" ]]; then
          echo "âœ… é•œåƒå·²æ¨é€åˆ°å®¹å™¨æ³¨å†Œè¡¨"
          echo "ğŸš€ ä½¿ç”¨æ–¹å¼:"
          echo "  docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
        else
          echo "â„¹ï¸  PRæ„å»º - é•œåƒæœªæ¨é€åˆ°æ³¨å†Œè¡¨"
        fi
