name: Build and Release

on:
  # åˆ›å»ºæ ‡ç­¾æ—¶è§¦å‘
  push:
    tags:
      - 'v*'
  
  # æ‰‹åŠ¨è§¦å‘å‘å¸ƒ
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.2)'
        required: true
        type: string
      create_release:
        description: 'æ˜¯å¦åˆ›å»ºGitHub Release'
        required: true
        default: true
        type: boolean

env:
  REGISTRY: ghcr.io
  BASE_IMAGE_NAME: ${{ github.repository }}-base
  APP_IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®Goç¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ç™»å½•åˆ°Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: æå–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION="${{ inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT
        echo "ğŸ·ï¸  ç‰ˆæœ¬: $VERSION"

    - name: æ„å»ºå‰ç«¯
      run: |
        echo "ğŸ”§ æ„å»ºå‰ç«¯..."
        cd frontend
        npm ci
        npm run build
        echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ"

    - name: æ„å»ºGoåº”ç”¨
      run: |
        echo "ğŸ”§ æ„å»ºGoåº”ç”¨..."
        
        VERSION="${{ steps.version.outputs.version_number }}"
        BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        GIT_COMMIT=${{ github.sha }}
        
        # æ„å»ºLinux amd64ç‰ˆæœ¬
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
          -ldflags="-w -s -X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME} -X main.GitCommit=${GIT_COMMIT}" \
          -o build/ssl-cert-system-linux-amd64 \
          cmd/server/main.go
        
        # æ„å»ºLinux arm64ç‰ˆæœ¬
        CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build \
          -ldflags="-w -s -X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME} -X main.GitCommit=${GIT_COMMIT}" \
          -o build/ssl-cert-system-linux-arm64 \
          cmd/server/main.go
        
        echo "âœ… Goåº”ç”¨æ„å»ºå®Œæˆ"

    - name: è¿è¡Œç”Ÿäº§æ„å»ºè„šæœ¬
      run: |
        echo "ğŸ“¦ è¿è¡Œç”Ÿäº§æ„å»ºè„šæœ¬..."
        chmod +x scripts/build-production.sh
        
        # è·³è¿‡Dockeræ„å»ºï¼Œå› ä¸ºæˆ‘ä»¬ä¼šåœ¨åé¢å•ç‹¬æ„å»º
        sed -i '/^echo "ğŸ³ æ„å»ºDockeré•œåƒ..."/,/^echo "âœ… Dockeré•œåƒæ„å»ºå®Œæˆ"/c\
echo "ğŸ³ è·³è¿‡Dockeré•œåƒæ„å»ºï¼ˆå°†åœ¨åç»­æ­¥éª¤ä¸­æ„å»ºï¼‰..."' scripts/build-production.sh
        
        ./scripts/build-production.sh
        echo "âœ… ç”Ÿäº§æ„å»ºå®Œæˆ"

    - name: æ„å»ºå¹¶æ¨é€åŸºç¡€é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.base
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.BASE_IMAGE_NAME }}:${{ steps.version.outputs.version }}
          ${{ env.REGISTRY }}/${{ env.BASE_IMAGE_NAME }}:latest
        build-args: |
          VERSION=${{ steps.version.outputs.version_number }}
          BUILD_TIME=${{ github.event.head_commit.timestamp }}
          GIT_COMMIT=${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: æ„å»ºå¹¶æ¨é€åº”ç”¨é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.APP_IMAGE_NAME }}:${{ steps.version.outputs.version }}
          ${{ env.REGISTRY }}/${{ env.APP_IMAGE_NAME }}:latest
        build-args: |
          VERSION=${{ steps.version.outputs.version_number }}
          BUILD_TIME=${{ github.event.head_commit.timestamp }}
          GIT_COMMIT=${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: åˆ›å»ºGitHub Release
      if: github.event_name != 'workflow_dispatch' || inputs.create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: SSLè¯ä¹¦ç®¡ç†ç³»ç»Ÿ ${{ steps.version.outputs.version }}
        body: |
          ## ğŸ‰ SSLè¯ä¹¦ç®¡ç†ç³»ç»Ÿ ${{ steps.version.outputs.version }} å‘å¸ƒ
          
          ### ğŸ“¦ å‘å¸ƒå†…å®¹
          - âœ… Goåç«¯åº”ç”¨ (Linux amd64/arm64)
          - âœ… Vue.jså‰ç«¯åº”ç”¨
          - âœ… Dockeré•œåƒ (å¤šæ¶æ„æ”¯æŒ)
          - âœ… å®Œæ•´å‘å¸ƒåŒ…
          
          ### ğŸ³ Dockeré•œåƒ
          ```bash
          # åŸºç¡€é•œåƒ
          docker pull ${{ env.REGISTRY }}/${{ env.BASE_IMAGE_NAME }}:${{ steps.version.outputs.version }}
          
          # åº”ç”¨é•œåƒ
          docker pull ${{ env.REGISTRY }}/${{ env.APP_IMAGE_NAME }}:${{ steps.version.outputs.version }}
          ```
          
          ### ğŸ“‹ éƒ¨ç½²æ–¹å¼
          1. **Dockeréƒ¨ç½²**: ä½¿ç”¨ä¸Šè¿°é•œåƒ
          2. **äºŒè¿›åˆ¶éƒ¨ç½²**: ä¸‹è½½å‘å¸ƒåŒ…ä¸­çš„äºŒè¿›åˆ¶æ–‡ä»¶
          3. **æºç æ„å»º**: å…‹éš†ä»“åº“å¹¶è¿è¡Œæ„å»ºè„šæœ¬
          
          ### ğŸ”— ç›¸å…³é“¾æ¥
          - [éƒ¨ç½²æ–‡æ¡£](https://github.com/${{ github.repository }}/blob/main/DEPLOYMENT.md)
          - [å¿«é€Ÿå¼€å§‹](https://github.com/${{ github.repository }}/blob/main/QUICK_START.md)
          
          ---
          **æ„å»ºä¿¡æ¯**
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - Gitæäº¤: ${{ github.sha }}
          - å·¥ä½œæµ: ${{ github.run_id }}
        files: |
          dist/*.tar.gz
          dist/checksums.*
        draft: false
        prerelease: false

    - name: è¾“å‡ºå‘å¸ƒä¿¡æ¯
      run: |
        echo "ğŸ‰ å‘å¸ƒå®Œæˆï¼"
        echo "ğŸ“‹ å‘å¸ƒä¿¡æ¯:"
        echo "  - ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
        echo "  - åŸºç¡€é•œåƒ: ${{ env.REGISTRY }}/${{ env.BASE_IMAGE_NAME }}:${{ steps.version.outputs.version }}"
        echo "  - åº”ç”¨é•œåƒ: ${{ env.REGISTRY }}/${{ env.APP_IMAGE_NAME }}:${{ steps.version.outputs.version }}"
        echo "  - å‘å¸ƒåŒ…: dist/ssl-cert-system-go-linux-${{ steps.version.outputs.version_number }}.tar.gz"
        echo ""
        echo "ğŸš€ ä½¿ç”¨æ–¹å¼:"
        echo "  docker run -d -p 3001:3001 ${{ env.REGISTRY }}/${{ env.APP_IMAGE_NAME }}:${{ steps.version.outputs.version }}"
