# 后端开发需求文档

## 1. 概述

本文档详细描述了SSL证书自动化管理系统的后端开发需求。后端采用Flask框架开发，提供RESTful API接口，实现用户认证、证书管理、自动部署和证书监控等核心功能，并与acme.sh和httpsok.sh工具集成，实现证书的自动化申请、部署和监控。

## 2. 技术栈

- **框架**：Flask 2.0+
- **ORM**：SQLAlchemy
- **数据库**：MySQL 5.7+ 
- **认证**：JWT (JSON Web Token)
- **API规范**：RESTful
- **文档**：Swagger/OpenAPI
- **测试**：pytest
- **证书工具**：acme.sh, httpsok.sh

## 3. 数据模型

### 3.1 用户模型 (User)
- id: 整型，主键
- username: 字符串，用户名，唯一
- email: 字符串，电子邮件，唯一
- password_hash: 字符串，密码哈希
- is_admin: 布尔值，是否为管理员
- created_at: 日期时间，创建时间
- updated_at: 日期时间，更新时间

### 3.2 证书模型 (Certificate)
- id: 整型，主键
- user_id: 整型，外键，关联用户
- domain: 字符串，主域名
- alt_domains: 字符串，备用域名，逗号分隔
- issuer: 字符串，证书颁发者（Google、Let's Encrypt、ZeroSSL）
- valid_from: 日期时间，生效时间
- valid_to: 日期时间，失效时间
- days_remaining: 整型，剩余有效天数
- encryption_type: 字符串，加密方式（ECC、RSA）
- status: 字符串，状态（已签发、未签发）
- verification_status: 字符串，域名验证状态
- cert_path: 字符串，证书文件路径
- key_path: 字符串，密钥文件路径
- note: 字符串，备注
- created_at: 日期时间，创建时间
- updated_at: 日期时间，更新时间

### 3.3 服务器模型 (Server)
- id: 整型，主键
- user_id: 整型，外键，关联用户
- type: 字符串，服务器类型（nginx、apache等）
- name: 字符串，服务器名称
- system: 字符串，操作系统信息
- ip_address: 字符串，IP地址
- version: 字符串，服务器版本
- status: 字符串，状态（正常、异常等）
- auto_deploy: 布尔值，是否启用自动部署
- last_update: 日期时间，最后更新时间
- note: 字符串，备注
- created_at: 日期时间，创建时间
- updated_at: 日期时间，更新时间

### 3.4 证书部署模型 (Deployment)
- id: 整型，主键
- certificate_id: 整型，外键，关联证书
- server_id: 整型，外键，关联服务器
- deploy_path: 字符串，部署路径
- status: 字符串，部署状态
- last_deployed: 日期时间，最后部署时间
- created_at: 日期时间，创建时间
- updated_at: 日期时间，更新时间

### 3.5 证书监控模型 (Monitor)
- id: 整型，主键
- user_id: 整型，外键，关联用户
- domain: 字符串，主机域名
- cert_level: 字符串，证书等级
- encryption_type: 字符串，加密方式
- port: 整型，端口
- ip_type: 字符串，IP类型
- ip_address: 字符串，IP地址
- status: 字符串，状态
- days_remaining: 整型，剩余有效天数
- is_active: 布尔值，检测开关
- note: 字符串，备注
- last_check: 日期时间，最后检测时间
- created_at: 日期时间，创建时间
- updated_at: 日期时间，更新时间

## 4. API接口

### 4.1 认证接口

#### 4.1.1 用户登录
- **URL**: `/api/auth/login`
- **方法**: POST
- **请求体**:
  ```json
  {
    "username": "string",
    "password": "string"
  }
  ```
- **响应**:
  ```json
  {
    "token": "string",
    "user": {
      "id": "integer",
      "username": "string",
      "email": "string",
      "is_admin": "boolean"
    }
  }
  ```

#### 4.1.2 用户登出
- **URL**: `/api/auth/logout`
- **方法**: POST
- **请求头**: Authorization: Bearer {token}
- **响应**:
  ```json
  {
    "message": "Logout successful"
  }
  ```

#### 4.1.3 刷新令牌
- **URL**: `/api/auth/refresh`
- **方法**: POST
- **请求头**: Authorization: Bearer {token}
- **响应**:
  ```json
  {
    "token": "string"
  }
  ```

### 4.2 证书管理接口

#### 4.2.1 获取证书列表
- **URL**: `/api/certificates`
- **方法**: GET
- **请求头**: Authorization: Bearer {token}
- **查询参数**:
  - search: 搜索关键词（域名或备注）
  - page: 页码
  - per_page: 每页数量
- **响应**:
  ```json
  {
    "certificates": [
      {
        "id": "integer",
        "domain": "string",
        "alt_domains": "string",
        "issuer": "string",
        "valid_from": "datetime",
        "valid_to": "datetime",
        "days_remaining": "integer",
        "encryption_type": "string",
        "status": "string",
        "verification_status": "string",
        "note": "string"
      }
    ],
    "total": "integer",
    "page": "integer",
    "per_page": "integer"
  }
  ```

#### 4.2.2 获取证书详情
- **URL**: `/api/certificates/{id}`
- **方法**: GET
- **请求头**: Authorization: Bearer {token}
- **响应**:
  ```json
  {
    "id": "integer",
    "domain": "string",
    "alt_domains": "string",
    "issuer": "string",
    "valid_from": "datetime",
    "valid_to": "datetime",
    "days_remaining": "integer",
    "encryption_type": "string",
    "status": "string",
    "verification_status": "string",
    "cert_path": "string",
    "key_path": "string",
    "note": "string",
    "created_at": "datetime",
    "updated_at": "datetime"
  }
  ```

#### 4.2.3 申请证书
- **URL**: `/api/certificates`
- **方法**: POST
- **请求头**: Authorization: Bearer {token}
- **请求体**:
  ```json
  {
    "domain": "string",
    "issuer": "string",
    "encryption_type": "string",
    "note": "string"
  }
  ```
- **响应**:
  ```json
  {
    "id": "integer",
    "domain": "string",
    "verification_status": "string",
    "verification_info": {
      "status": "string",
      "provider": "string",
      "host": "string",
      "type": "string",
      "value": "string"
    }
  }
  ```

#### 4.2.4 验证域名
- **URL**: `/api/certificates/{id}/verify`
- **方法**: POST
- **请求头**: Authorization: Bearer {token}
- **响应**:
  ```json
  {
    "success": "boolean",
    "message": "string",
    "certificate": {
      "id": "integer",
      "domain": "string",
      "status": "string"
    }
  }
  ```

#### 4.2.5 更新证书信息
- **URL**: `/api/certificates/{id}`
- **方法**: PUT
- **请求头**: Authorization: Bearer {token}
- **请求体**:
  ```json
  {
    "note": "string"
  }
  ```
- **响应**:
  ```json
  {
    "id": "integer",
    "domain": "string",
    "note": "string",
    "updated_at": "datetime"
  }
  ```

#### 4.2.6 删除证书
- **URL**: `/api/certificates/{id}`
- **方法**: DELETE
- **请求头**: Authorization: Bearer {token}
- **响应**:
  ```json
  {
    "message": "Certificate deleted successfully"
  }
  ```

#### 4.2.7 下载证书
- **URL**: `/api/certificates/{id}/download`
- **方法**: GET
- **请求头**: Authorization: Bearer {token}
- **查询参数**:
  - format: 证书格式（pem、pfx等）
- **响应**: 二进制文件流

#### 4.2.8 删除失效证书
- **URL**: `/api/certificates/cleanup`
- **方法**: POST
- **请求头**: Authorization: Bearer {token}
- **响应**:
  ```json
  {
    "message": "Expired certificates deleted successfully",
    "count": "integer"
  }
  ```

### 4.3 自动部署接口

#### 4.3.1 获取服务器列表
- **URL**: `/api/servers`
- **方法**: GET
- **请求头**: Authorization: Bearer {token}
- **响应**:
  ```json
  {
    "servers": [
      {
        "id": "integer",
        "type": "string",
        "name": "string",
        "system": "string",
        "ip_address": "string",
        "version": "string",
        "status": "string",
        "last_update": "datetime",
        "auto_deploy": "boolean",
        "note": "string"
      }
    ]
  }
  ```

#### 4.3.2 获取服务器详情
- **URL**: `/api/servers/{id}`
- **方法**: GET
- **请求头**: Authorization: Bearer {token}
- **响应**:
  ```json
  {
    "id": "integer",
    "type": "string",
    "name": "string",
    "system": "string",
    "ip_address": "string",
    "version": "string",
    "status": "string",
    "last_update": "datetime",
    "auto_deploy": "boolean",
    "note": "string",
    "created_at": "datetime",
    "updated_at": "datetime"
  }
  ```

#### 4.3.3 添加服务器
- **URL**: `/api/servers`
- **方法**: POST
- **请求头**: Authorization: Bearer {token}
- **请求体**:
  ```json
  {
    "type": "string",
    "name": "string",
    "system": "string",
    "ip_address": "string",
    "version": "string",
    "auto_deploy": "boolean",
    "note": "string"
  }
  ```
- **响应**:
  ```json
  {
    "id": "integer",
    "type": "string",
    "name": "string",
    "system": "string",
    "ip_address": "string",
    "version": "string",
    "status": "string",
    "auto_deploy": "boolean",
    "note": "string",
    "created_at": "datetime"
  }
  ```

#### 4.3.4 更新服务器信息
- **URL**: `/api/servers/{id}`
- **方法**: PUT
- **请求头**: Authorization: Bearer {token}
- **请求体**:
  ```json
  {
    "name": "string",
    "auto_deploy": "boolean",
    "note": "string"
  }
  ```
- **响应**:
  ```json
  {
    "id": "integer",
    "name": "string",
    "auto_deploy": "boolean",
    "note": "string",
    "updated_at": "datetime"
  }
  ```

#### 4.3.5 删除服务器
- **URL**: `/api/servers/{id}`
- **方法**: DELETE
- **请求头**: Authorization: Bearer {token}
- **响应**:
  ```json
  {
    "message": "Server deleted successfully"
  }
  ```

### 4.4 证书监控接口

#### 4.4.1 获取监控列表
- **URL**: `/api/monitors`
- **方法**: GET
- **请求头**: Authorization: Bearer {token}
- **响应**:
  ```json
  {
    "monitors": [
      {
        "id": "integer",
        "domain": "string",
        "cert_level": "string",
        "encryption_type": "string",
        "port": "integer",
        "ip_type": "string",
        "ip_address": "string",
        "status": "string",
        "days_remaining": "integer",
        "is_active": "boolean",
        "note": "string",
        "last_check": "datetime"
      }
    ]
  }
  ```

#### 4.4.2 获取监控详情
- **URL**: `/api/monitors/{id}`
- **方法**: GET
- **请求头**: Authorization: Bearer {token}
- **响应**:
  ```json
  {
    "id": "integer",
    "domain": "string",
    "cert_level": "string",
    "encryption_type": "string",
    "port": "integer",
    "ip_type": "string",
    "ip_address": "string",
    "status": "string",
    "days_remaining": "integer",
    "is_active": "boolean",
    "note": "string",
    "last_check": "datetime",
    "created_at": "datetime",
    "updated_at": "datetime"
  }
  ```

#### 4.4.3 添加监控
- **URL**: `/api/monitors`
- **方法**: POST
- **请求头**: Authorization: Bearer {token}
- **请求体**:
  ```json
  {
    "domain": "string",
    "port": "integer",
    "ip_type": "string",
    "ip_address": "string",
    "is_active": "boolean",
    "note": "string"
  }
  ```
- **响应**:
  ```json
  {
    "id": "integer",
    "domain": "string",
    "port": "integer",
    "ip_type": "string",
    "ip_address": "string",
    "is_active": "boolean",
    "note": "string",
    "created_at": "datetime"
  }
  ```

#### 4.4.4 更新监控
- **URL**: `/api/monitors/{id}`
- **方法**: PUT
- **请求头**: Authorization: Bearer {token}
- **请求体**:
  ```json
  {
    "is_active": "boolean",
    "note": "string"
  }
  ```
- **响应**:
  ```json
  {
    "id": "integer",
    "is_active": "boolean",
    "note": "string",
    "updated_at": "datetime"
  }
  ```

#### 4.4.5 删除监控
- **URL**: `/api/monitors/{id}`
- **方法**: DELETE
- **请求头**: Authorization: Bearer {token}
- **响应**:
  ```json
  {
    "message": "Monitor deleted successfully"
  }
  ```

#### 4.4.6 执行证书检测
- **URL**: `/api/monitors/{id}/check`
- **方法**: POST
- **请求头**: Authorization: Bearer {token}
- **响应**:
  ```json
  {
    "id": "integer",
    "domain": "string",
    "status": "string",
    "days_remaining": "integer",
    "cert_level": "string",
    "encryption_type": "string",
    "last_check": "datetime"
  }
  ```

## 5. 核心功能实现

### 5.1 证书申请与验证

后端需要集成acme.sh工具，实现以下功能：

1. **域名验证信息生成**：
   - 根据用户提供的域名，生成DNS验证记录信息
   - 支持不同CA提供商（Google、Let's Encrypt、ZeroSSL）的验证方式

2. **域名验证检查**：
   - 定期检查DNS记录是否已正确配置
   - 提供手动触发验证的接口

3. **证书申请**：
   - 验证通过后，调用acme.sh申请证书
   - 支持不同的加密算法（ECC、RSA）
   - 处理申请过程中的错误和异常

4. **证书存储**：
   - 安全存储证书文件和私钥
   - 提供证书下载功能，支持不同格式

### 5.2 自动部署

后端需要实现证书自动部署功能：

1. **服务器连接**：
   - 支持SSH连接到远程服务器
   - 管理SSH密钥或凭据

2. **证书部署**：
   - 将证书文件安全传输到目标服务器
   - 根据服务器类型（nginx、apache等）生成配置
   - 重启或重载Web服务

3. **部署状态监控**：
   - 检查部署是否成功
   - 记录部署历史和状态

### 5.3 证书监控

后端需要实现证书监控功能：

1. **证书检测**：
   - 定期检查证书有效性
   - 获取证书详细信息（颁发者、有效期等）
   - 计算剩余有效天数

2. **状态更新**：
   - 更新证书状态和剩余天数
   - 记录检测历史

3. **告警机制**：
   - 当证书即将过期时发送告警
   - 支持不同的告警级别和通知方式

## 6. 定时任务

后端需要实现以下定时任务：

1. **证书状态检查**：每天检查证书状态和剩余有效期
2. **自动续期**：对即将过期的证书自动申请续期
3. **自动部署**：对已启用自动部署的服务器，自动部署新证书
4. **监控检测**：按配置的频率执行证书监控检测

## 7. 安全要求

1. **认证与授权**：
   - 实现JWT认证机制
   - 基于角色的访问控制
   - 防止未授权访问

2. **数据安全**：
   - 密码哈希存储
   - 敏感信息加密
   - 证书私钥安全存储

3. **API安全**：
   - 防止CSRF攻击
   - 输入验证和过滤
   - 限制请求频率

4. **日志与审计**：
   - 记录关键操作日志
   - 异常行为监控
   - 定期安全审计

## 8. 性能要求

1. **响应时间**：
   - API响应时间不超过500毫秒（不包括证书操作时间）
   - 证书操作（申请、验证等）需提供进度反馈

2. **并发处理**：
   - 支持多用户并发操作
   - 长时间操作（如证书申请）应异步处理

3. **数据库优化**：
   - 合理设计索引
   - 优化查询性能
   - 定期维护和清理

## 9. 日志与监控

1. **应用日志**：
   - 记录系统操作日志
   - 记录错误和异常
   - 不同级别的日志（DEBUG、INFO、WARNING、ERROR）

2. **系统监控**：
   - 监控API性能和可用性
   - 监控证书操作状态
   - 监控系统资源使用情况

## 10. 测试要求

1. **单元测试**：
   - 核心功能单元测试
   - 模拟外部依赖（acme.sh、SSH等）

2. **集成测试**：
   - API接口测试
   - 数据库交互测试

3. **系统测试**：
   - 端到端功能测试
   - 性能和负载测试

## 11. 部署要求

1. **环境支持**：
   - 支持Docker容器化部署
   - 支持常见Linux发行版（Ubuntu、CentOS等）

2. **配置管理**：
   - 通过环境变量或配置文件进行配置
   - 支持不同环境（开发、测试、生产）的配置

3. **数据库迁移**：
   - 提供数据库迁移脚本
   - 支持版本升级和回滚

## 12. 文档要求

1. **API文档**：
   - 使用Swagger/OpenAPI生成API文档
   - 详细的接口说明和示例

2. **代码文档**：
   - 代码注释
   - 模块和函数说明

3. **部署文档**：
   - 详细的部署步骤
   - 环境要求和配置说明

## 13. 开发规范

1. **代码风格**：
   - 遵循PEP 8编码规范
   - 使用pylint或flake8进行代码检查

2. **版本控制**：
   - 使用Git进行版本控制
   - 遵循语义化版本规范

3. **代码审查**：
   - 提交前进行代码审查
   - 持续集成测试

## 14. 交付物

1. **源代码**：
   - 后端API服务代码
   - 数据库迁移脚本
   - 配置文件模板

2. **文档**：
   - API文档
   - 部署文档
   - 开发文档

3. **测试**：
   - 单元测试代码
   - 测试报告

4. **部署脚本**：
   - Docker配置文件
   - 部署脚本
